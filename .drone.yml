---
kind: pipeline
type: docker
name: default

clone:
  depth: 1

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock

x-docker-step: &docker-step
  image: docker
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  environment:
    BUILD_TAG: ${DRONE_BRANCH}-${DRONE_COMMIT}
    DOCKER_USERNAME:
      from_secret: DOCKER_USERNAME
    DOCKER_PASSWORD:
      from_secret: DOCKER_PASSWORD

x-docker-auth:
- &docker-auth docker login harbor.zyra.ca -u $DOCKER_USERNAME -p $DOCKER_PASSWORD


steps:
- name: Test
  image: golang:1.13-alpine
  when:
    event: push
  commands:
  - apk add gcc musl-dev
  - go test -mod vendor ./parser/...
  - go test -mod vendor ./typescript/...

- name: Build docker image
  <<: *docker-step
  commands:
  - docker build -t harbor.zyra.ca/public/gots:$BUILD_TAG .

- name: Push docker image
  <<: *docker-step
  commands:
  - *docker-auth
  - docker push harbor.zyra.ca/public/gots:$BUILD_TAG

- name: Push latest docker image
  <<: *docker-step
  when:
    branch:
    - master
  commands:
  - *docker-auth
  - docker tag harbor.zyra.ca/public/gots:$BUILD_TAG harbor.zyra.ca/public/gots:latest
  - docker push harbor.zyra.ca/public/gots:latest

- name: Push version tagged image
  <<: *docker-step
  when:
    event:
    - tag
  commands:
  - *docker-auth
  - docker tag harbor.zyra.ca/public/gots:$BUILD_TAG harbor.zyra.ca/public/gots:$DRONE_TAG
  - docker push harbor.zyra.ca/public/gots:$DRONE_TAG


- name: Build binaries
  image: golang:1.13-alpine
  when:
    event:
    - tag
  commands:
  - apk add git make
  - make build -j$(nproc)

- name: Publish binaries to Github
  image: plugins/github-release
  when:
    event:
    - tag
  settings:
    api_key:
      from_secret: github_secret
    files:
    - bin/gots_darwin_amd64
    - bin/gots_linux_amd64
    - bin/gots_windows_amd64.exe
    checksum:
    - md5
    - sha1
    - sha256
    - sha512
---
kind: signature
hmac: a7894949813f0d5a3280dc0264284b2b152c2453ffceb58b8d38e999459d4dd8

...
